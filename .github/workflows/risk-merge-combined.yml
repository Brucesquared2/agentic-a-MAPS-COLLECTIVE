name: Risk Merge (Validator + PR Flow)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  validate-manifests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pyyaml pytest
      - name: Run manifest validator
        run: python scripts/validate_manifest.py
      - name: Run validator unit tests
        run: pytest -q tests/test_validate_manifest.py

  merge-risk-pr:
    runs-on: ubuntu-latest
    needs: validate-manifests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install pyyaml
      - name: Run risk merger
        run: python scripts/merge_risk.py
      - name: Commit merged risk.yml
        run: |
          git config --global user.name "ci-bot"
          git config --global user.email "ci-bot@example.com"
          git add ta_service/config/risk.yml
          git commit -m "chore(risk): auto-merge manifests into risk.yml" || echo "No changes"
      - name: Connectivity check (GitHub reachability)
        run: |
          echo "üîç Checking DNS + network connectivity to github.com..."
          ping -c 3 github.com || (echo "‚ùå DNS/Network issue: cannot reach github.com" && exit 1)
          curl -I -sS https://github.com || (echo "‚ùå HTTP issue: cannot reach github.com" && exit 1)
          echo "‚úÖ Connectivity OK"
        shell: bash
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.REPO_WRITE_TOKEN }}
          commit-message: "chore(risk): auto-merge manifests into risk.yml"
          title: "chore(risk): auto-merge manifests"
          body: |
            This PR was auto-generated by CI to merge risk policies from indicator manifests.
            Review the changes in `ta_service/config/risk.yml` before merging.
          branch: ci/risk-merge-${{ github.sha }}
          delete-branch: true
